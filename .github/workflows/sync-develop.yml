name: Sync Release Back to Develop

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  fast-forward-develop:
    name: Fast-forward develop from main
    runs-on: ubuntu-latest
    steps:
      - name: Skip if not release commit
        if: ${{ !startsWith(github.event.head_commit.message, 'chore(main): release') }}
        run: |
          echo "commit is not a release; skipping" >> "$GITHUB_STEP_SUMMARY"
          exit 0

      - name: Checkout main
        if: ${{ startsWith(github.event.head_commit.message, 'chore(main): release') }}
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Ensure develop is ancestor
        if: ${{ startsWith(github.event.head_commit.message, 'chore(main): release') }}
        id: ancestor
        run: |
          git fetch origin develop
          if git merge-base --is-ancestor origin/develop HEAD; then
            echo "ff-possible=true" >> "$GITHUB_OUTPUT"
          else
            echo "ff-possible=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Push fast-forward to develop
        if: ${{ startsWith(github.event.head_commit.message, 'chore(main): release') && steps.ancestor.outputs.ff-possible == 'true' }}
        run: |
          git push origin HEAD:develop

      - name: Report skipped fast-forward
        if: ${{ startsWith(github.event.head_commit.message, 'chore(main): release') && steps.ancestor.outputs.ff-possible != 'true' }}
        run: |
          echo "develop has diverged; manual intervention required" >> "$GITHUB_STEP_SUMMARY"
          exit 1
